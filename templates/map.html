{% extends "layout.html" %}
{% block title %}Property Map - PropIntel{% endblock %}

{% block extra_head %}
<style>
    #full-map {
        height: calc(100vh - 150px);
        width: 100%;
        border-radius: 0.375rem;
        z-index: 1;
    }
    
    .map-sidebar {
        max-height: calc(100vh - 150px);
        overflow-y: auto;
    }
    
    .property-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .property-item:hover {
        background-color: #f8f9fa;
    }
    
    .property-item.active {
        background-color: #e9ecef;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Property Map</h1>
    <a href="{{ url_for('properties') }}" class="btn btn-outline-secondary">
        <i class="fas fa-list me-1"></i> Property List
    </a>
</div>

<div class="row">
    <div class="col-md-9">
        <div class="card">
            <div class="card-body p-0">
                <div id="full-map"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card map-sidebar">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Properties</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="property-list">
                    <!-- Property items will be added dynamically with JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load Leaflet heat plugin
    document.write('<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"><\/script>');
    
    // Initialize full map with enhanced controls
    const map = L.map('full-map', {
        zoomControl: true,
        scrollWheelZoom: true, 
        fullscreenControl: true
    }).setView([{{ center_lat }}, {{ center_lng }}], 11);
    
    // Add scale control
    L.control.scale().addTo(map);
    
    // Map tile layers
    const baseLayers = {
        "Standard": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map),
        "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }),
        "Dark": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }),
        "Terrain": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
        })
    };
    
    // Add layer control to map
    L.control.layers(baseLayers, null, {position: 'topright'}).addTo(map);
    
    // Add property markers
    const properties = {{ geojson|safe }};
    const propertyList = document.getElementById('property-list');
    const markers = {};
    
    // Create work heatmap layer
    const heatmapData = [];
    properties.features.forEach(feature => {
        if (feature.properties.work_count > 0) {
            const coords = feature.geometry.coordinates;
            heatmapData.push([
                coords[1], 
                coords[0], 
                Math.min(feature.properties.work_count / 2, 1) // Normalize intensity
            ]);
        }
    });
    
    // Create heatmap layer if we have data
    let heatmapLayer = null;
    if (heatmapData.length > 0) {
        heatmapLayer = L.heatLayer(heatmapData, {
            radius: 25,
            blur: 15,
            maxZoom: 17,
            max: 1.0,
            gradient: {0.4: 'blue', 0.65: 'lime', 0.85: 'yellow', 1.0: 'red'}
        });
    }
    
    // Overlay layers
    const overlays = {
        "Properties": L.layerGroup().addTo(map),
        "Work Heatmap": heatmapLayer
    };
    
    // Update layer control
    L.control.layers(baseLayers, overlays, {position: 'topright'}).addTo(map);
    
    // Create GeoJSON layer with custom markers/polygons and popups
    const propertiesLayer = L.geoJSON(properties, {
        pointToLayer: function(feature, latlng) {
            // Only called for Point geometries
            // Determine marker style based on work count
            const workCount = feature.properties.work_count || 0;
            const expenseCount = feature.properties.expense_count || 0;
            const incomeCount = feature.properties.income_count || 0;
            
            // Determine if property might be over budget
            const potentiallyOverBudget = feature.properties.is_over_budget || false;
            
            // Create custom icon
            const markerHtml = `
                <div class="custom-marker ${potentiallyOverBudget ? 'over-budget' : ''}" 
                     style="background-color: ${potentiallyOverBudget ? '#dc3545' : '#0d6efd'}; 
                            width: 32px; height: 32px; 
                            border-radius: 50%; 
                            display: flex; 
                            justify-content: center; 
                            align-items: center; 
                            color: white; 
                            font-weight: bold; 
                            border: 2px solid white; 
                            box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                    <i class="fas fa-home"></i>
                </div>`;
            
            const customIcon = L.divIcon({
                html: markerHtml,
                className: '',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            
            const marker = L.marker(latlng, {icon: customIcon});
            markers[feature.properties.id] = marker;
            return marker;
        },
        style: function(feature) {
            // Style for Polygon geometries (buildings)
            // Determine if property might be over budget
            const potentiallyOverBudget = feature.properties.is_over_budget || false;
            
            return {
                fillColor: potentiallyOverBudget ? '#dc3545' : '#0d6efd',
                color: '#ffffff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.7
            };
        },
        onEachFeature: function(feature, layer) {
            const property = feature.properties;
            
            // Create improved popup content
            const workCount = property.work_count || 0;
            const expenseCount = property.expense_count || 0;
            const incomeCount = property.income_count || 0;
            
            const popupContent = `
                <div class="property-popup">
                    <h6 class="mb-2">${property.name}</h6>
                    <p class="mb-2"><i class="fas fa-map-marker-alt me-1 text-danger"></i> ${property.address}</p>
                    
                    <div class="mb-3 small">
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-tools me-1"></i> Work Items:</span>
                            <strong>${workCount}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-dollar-sign me-1 text-success"></i> Income:</span>
                            <strong>${incomeCount}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-file-invoice-dollar me-1 text-danger"></i> Expenses:</span>
                            <strong>${expenseCount}</strong>
                        </div>
                    </div>
                    
                    <a href="${property.url}" class="btn btn-sm btn-primary w-100">
                        <i class="fas fa-info-circle me-1"></i> View Details
                    </a>
                </div>
            `;
            
            // Bind popup to layer (either marker or polygon)
            layer.bindPopup(popupContent);
            
            // Store reference to the layer for sidebar interaction
            markers[property.id] = layer;
            
            // Add highlight on hover
            layer.on('mouseover', function() {
                if (feature.geometry.type === 'Polygon') {
                    this.setStyle({
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.9
                    });
                }
            });
            
            // Reset style on mouseout
            layer.on('mouseout', function() {
                if (feature.geometry.type === 'Polygon') {
                    propertiesLayer.resetStyle(this);
                }
            });
            
            // Create sidebar item
            const listItem = document.createElement('a');
            listItem.href = '#';
            listItem.className = 'list-group-item list-group-item-action property-item';
            listItem.setAttribute('data-property-id', property.id);
            listItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${property.name}</h6>
                </div>
                <small>${property.address}</small>
            `;
            
            // Add click event to list item
            listItem.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Highlight active property
                document.querySelectorAll('.property-item').forEach(item => {
                    item.classList.remove('active');
                });
                this.classList.add('active');
                
                // Fly to layer and open popup
                const layer = markers[property.id];
                if (feature.geometry.type === 'Polygon') {
                    // For polygons, fly to bounds
                    map.flyToBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 18 });
                } else {
                    // For points, fly to latlng
                    map.flyTo(layer.getLatLng(), 18);
                }
                layer.openPopup();
            });
            
            // Add to sidebar
            propertyList.appendChild(listItem);
        }
    }).addTo(map);
    
    // Fit map to property bounds if there are properties
    if (properties.features.length > 0) {
        map.fitBounds(propertiesLayer.getBounds());
    }
</script>
{% endblock %}